on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:
  schedule:
    - cron: '44 4 * * 0'

jobs:
  shmem_matrix:
    strategy:
      fail-fast: false
      matrix:
        shmem: [sos, oshmem, oshmem_ubuntu, oshmem_fedora, oshmpi, osss]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - uses: jpribyl/action-docker-layer-caching@v0.1.1
        with:
          key: ${{ matrix.shmem }}-1-{hash}
          restore-keys: |
            ${{ matrix.shmem }}-1-
      - name: Build Docker container
        run: docker build -t local docker/${{ matrix.shmem }}/
      - name: run shmem4py test-1
        run: docker run -v $PWD:/repo -w/repo local /bin/bash -c "pip install . && make test-1 opt=-v"
      - name: run shmem4py test-2
        run: docker run -v $PWD:/repo -w/repo local /bin/bash -c "pip install . && make test-2 opt=-v"
      - name: clean docker cache
        run: docker image prune --all --force --filter "until=168h"
